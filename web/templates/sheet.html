{% include 'header.html' %}
<head>
  <script src="/static/abcjs-basic-min.js"></script>
<style>
  iframe {
    height: 800px;
    width: 600px;
    resize: both;
    overflow: auto;
}
</style>
</head>
<body bgcolor="#fff">
<div id="my_score">
  <div id="top"><span id="sheet_title"></span>&nbsp;<span id="sheet_btn"></span></div>
  Tempo: <input id="tempo" size="5"/>&nbsp;&nbsp;<div id="tools"></div>
  <div id="abc">
  </div>
  <textarea id="abc_data" rows="10" cols="100"></textarea>
  <div style="text-align:center" id="sheet"></div>
</div>
</body>
<script>
  let sheets = {{ sheets|safe }};
  let index = 0;
  let key_index = 0;
  let root = '';
  let abc_data;
  const keys_1 = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
  const keys_2 = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
  var spinner = $( "#tempo" ).spinner();

  $(document).on('click', 'button', function() {
    // Reload abc sheet with key_index changed
    key_index = keys.indexOf($(this).attr('name')) - keys.indexOf(root);
    ABCJS.renderAbc("abc", data.abc, {visualTranspose: key_index});
  });

  function load_sheet(type, k_index) {
    data = sheets[index];
    $('#abc_data').val(data.abc);

    if (type == 'abc') {
      $("#sheet").hide();

      // Load abc data
      $.when(ABCJS.renderAbc("abc", data.abc)).then(function(abc) {
        abc_data = abc[0];
        $("#abc").show();
        root = abc_data.getKeySignature().root;
        tempo = abc_data.getBpm();
        keys = keys_1;
        if(['Db', 'Eb', 'F', 'Ab', 'Bb'].indexOf(root) >= 0) {
            keys = keys_2;
        }

        html = '';
        for(var i=0;i<keys.length;i++) {
            if (keys[i] == root) {
              html += '<button title="Original Key" name="' + root + '"><b>' + root + '</b></button>';
            }
            else {
              html += '<button name="' + keys[i] + '">' + keys[i] + '</button>';
            }
        }
        $('#tempo').val(tempo);
        $('#tools').html(html);
      });
    }
    else if (type == 'sheet') {
      if(['bmp', 'jpg', 'png', 'gif'].some(char => data.sheet.endsWith(char))) {
        temp = '<img src="' + data.sheet + '" style="max-width: 100%;max-height: 100vh;margin: auto;"/>';
      }
      else {
        temp = '<iframe id="sheet_link" src="' + data.sheet + '"></iframe>';
      }
        $("#abc").hide();
        $('#sheet').empty();
        $('#sheet').append(temp);
        $('#sheet').show();
    }
  }

  function load_sheet_btn(n) {
    data = sheets[n];
    html = '';
    if(data.abc) {
      html += '<button class="type_btn" name="abc" onclick="load_sheet(this.name)">Interact Sheet</button>';
    }
    if(data.sheet) {
      html += '<button class="type_btn" name="sheet" onclick="load_sheet(this.name)">Normal Sheet</button>';
    }
    $('#sheet_btn').html(html);
    if(data.abc) {
      load_sheet('abc', key_index);
    }
    else {
      load_sheet('sheet');
    }
  }

  $(document).ready(function() {
    // Form select box with song title
    if (sheets.length > 1) {
      var songs = '<select name="songs" id="song_list">';
      for(var s=0;s<sheets.length;s++) {
        data = sheets[s];
        songs += '<option value=' + s + '>' + data.title + '</option>';
      }
      songs += '</select>';
      $("#sheet_title").html(songs);
    }
    load_sheet_btn(index);

    $('#song_list').change(function(){
      index = this.value;
      load_sheet_btn(index);
    });
  });

</script>
</body>