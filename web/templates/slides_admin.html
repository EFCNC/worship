<!--
    This is a preview page to show how worship presentation will look like
    param: id=worship_id, role=role_id
    keypress: TODO
-->

{% include 'header.html' %}
    <script src="../static/socket.io.js"></script>
    <script src="../static/presentation.js"></script>
    <link href="../static/presentation.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
        html {
            height: 100%;
            background-color: #000;
        }

        body {
            overflow: hidden;
        }

        .material-icons {
            font-size: 40px;
            padding: 10px;
        }

        .material-icons.small {
            font-size: 25px;
            padding: 4px;
        }

        .material-icons.disabled {
            //display: none;
        }

        i:hover {
            cursor: pointer;
            color: #fff;
            background-color: #000;
        }

        #image_icon img {
            padding: 5px;
            width: 50px;
        }

        #image_icon img:hover {
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        #edit_btn {
            position: fixed;
            z-index: 99;
            display: none;
        }

        #image_icon {
            border: 1px solid #000;
            border-radius: 4px;
            background-color: #002147;
            display: none;
            z-index: 1;
        }
</style>
<body>
<div class="admin_container"><div id="preview"></div>
    <div id="menu">
        <div id="control_panel"><div id="edit_btn"><i class="material-icons small disabled" name="one" title="Apply">&#xE876;</i><i class="material-icons small disabled" name="all" title="Apply All">&#xE877;</i><i class="material-icons small disabled" name="cancel" title="Cancel">&#xE5C9;</i></div>
            <br/><textarea id="content" rows="3" cols="40"></textarea>&nbsp;&nbsp;<i class="material-icons small" name="0" title="Send a message to view">&#xE163;</i><i class="material-icons small" name="-1" title="Clear the message">&#xE14C;</i>
            <br/><i class="material-icons small" name="1" title="Add a slide">&#xE89C;</i><i class="material-icons small" name="2" title="Add a sermon link">&#xE250;</i><i class="material-icons small" name="3" title="Add Background">&#xE3F4;</i><!--<i class="material-icons small" name="left" title="Align Left">&#xE236;</i><i class="material-icons small" name="center" title="Align Center">&#xE234;</i><i class="material-icons small" name="right" title="Align Right">&#xE237;</i>-->
        </div>
        <hr/>
        <div id="image_icon"></div>
        <div id="title" class="admin title" title="Title"></div><br/><b>Notes</b><div id="notes" class="admin notes" title="Notes"></div>
    </div>
    <div id="control_div">
        <div id="control_btn"><!--<i id="first" class="material-icons" title="First Topic">&#xe5dc;</i>--><i id="pre" class="material-icons" title="Previous Slide">&#xe5c4;</i><i id="up" class="material-icons" title="Previous Page">&#xe5d8;</i><i id="down" class="material-icons" title="Next Page">&#xe5db;</i><i id="next" class="material-icons" title="Next Slide">&#xe5c8;</i><!--<i id="last" class="material-icons" title="Last Topic">&#xe5dd;</i>--><i id="save" class="material-icons" title="Download Slides as Html">&#xE2C0;</i><i id="present" class="material-icons" title="Casting View">&#xE30C;</i></div>
    </div>
</div>
</body>
<script>
        let preview = $('#preview');    // Declare target div for load() function
        mode = 'admin';                 // Set mode to lead
        bg_url = '';
        a_type = '';
        origin_text = '輸入您的資訊';
        region_text = 'Enter your extra language information here';

        socket.on('connect', function () {
            console.log('Admin connected to the server');
        });

        socket.on('reload', function (presentation) {
            console.log('Admin reload json data');
            slides = presentation['data'];
            w_id = presentation['id'];
            load(preview);
            //pos = presentation['pos'][0];
            //order = presentation['pos'][1];
        });

        socket.on('response', function (data) {
            console.log('Server sent: ' + data);
            slides = data.data;
            pos = data.pos[0];
            order = data.pos[1];
            msg = data.msg;
            dynamic = data.dynamic;
            load(preview);
        });

        presentation = {{ presentation|safe }};
        slides = presentation['data'];
        pos = presentation['pos'][0];
        order = presentation['pos'][1];
        background = presentation['background'];
        w_id = presentation['id'];

        function add_background() {
            $('#image_icon').toggle();
            if ($('#image_icon').is(":visible")) {
                var url = '/API/backgrounds';
                $.when( $.ajax( url ) ).then(function( response, textStatus, jqXHR ) {
                    var temp = '';
                    for (var i=0;i<response.length;i++) {
                        temp += '<img src="' + response[i] + '" title="' + response[i] + '"/>';
                    }
                    $('#image_icon').html(temp);
                    a_type = 'bg';
                });
            }
            else {
                bg_url = '';
                a_type = '';
                $('#edit_btn').hide();
            }
        }

        function add_slide(num) {
            if (num == 1) { // For adding sermon slide
                $("#preview").find('.content').html('<iframe id="sermon_frame" frameborder="0" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe><br/><textarea row="5" cols="60" id="google_url"></textarea><button id="sermon_add_btn">OK</button>');
                $("#google_url").change(function() {
                    $("#sermon_frame").attr('src', $(this).val());
                });
                $("#sermon_add_btn").click(function() {
                    if ($("#sermon_frame").attr('src') != '' ) {
                        info = {"alt_sequence": "", "author": "", "style": {"align": "", "background": ""}, "bible": "", "book": "", "ccli": "", "content": $("#sermon_frame").attr('src'), "copyright": "", "date": "", "id": 115, "key": "", "lang": "", "lang_2": "", "lyricist": "", "lyrics_raw": "", "notes": "Showing embedded sermon slides, please move the focus to the view mode.", "score": "", "sequence": "", "title": "Sermon", "type": "link", "version": "", "video": ""};
                        slides.splice(pos+1, 0, info);
                        update_json();
                    }
                });
            }
            else { // For adding info slide
                $("#preview").find('.content').html('<div id="info_origin" contentEditable="true">' + origin_text + '</div><div id="info_region" contentEditable="true">' + region_text + '</div>');
                h = $("#preview").height()/2;
                w = $("#preview").width();
                $("#info_origin").css("width", w );
                $("#info_origin").css("height", h );
                $("#info_region").css("width", w );
                $("#info_region").css("height", h );
                $("#info_origin").click(function() {
                    if($(this).html() == origin_text) {
                        $(this).html('');
                    }
                });
                $("#info_region").click(function() {
                    if($(this).html() == region_text) {
                        $(this).html('');
                    }
                });
                $("#info_origin").focusout(function() {
                    if($(this).html() == '' && $(this).html != origin_text) {
                        $(this).html(origin_text);
                    }
                });
                $("#info_region").focusout(function() {
                    if($(this).html() == '' && $(this).html != region_text) {
                        $(this).html(region_text);
                    }
                });
            }
            a_type = 'info';
            console.log(pos, order, w_id);
        }

        function send_msg(data) {
            socket.emit('control', {'type': 'msg', 'value': data});
        }

        $(document).ready(function() {
            load(preview);
        });

        $(document).on('click', '#image_icon img', function() {
            $("#preview").css('background-image', 'url(' + this.src + ')');
            bg_url = this.title;
            $('#edit_btn').css('left', $('#preview').width()-90);
            $('#edit_btn').show();
        });

        $("#control_btn i").click(function() {
            name = $(this).attr('id');
            switch(name) {
                case 'pre':
                    move(0, -1);
                    break;
                case 'next':
                    move(0, 1);
                    break;
                case 'up':
                    move(1, -1);
                    break;
                case 'down':
                    move(1, 1);
                    break;
                case 'first':
                    pos = 0;
                    order = 0;
                    break;
                case 'last':
                    pos = slides.length-1
                    order = slides[slides.length-1].content.length-1;
                    break;
                case 'present':
                    window.open('/slides/view', '_blank');
                    break;
                case 'save':
                    save_slides();
                    break;
            }

        });

        function cancel() {
            $('#preview').css('background-image', 'url(' + slides[pos]['style']['background'] + ')');
            $('#edit_btn').hide();
        }

        function apply(name) {
            if (a_type == 'bg') {
                if (name == 'all') {
                    for(var i=0;i<slides.length;i++) {
                        slides[i].style.background = bg_url;
                    }
                }
                else {
                    slides[pos].style.background = bg_url;
                }
            }
            else if (a_type == 'info') {
                origin = $('#info_origin').html();
                region = $('#info_region').html();
                info = {"alt_sequence": "", "author": "", "style": {"align": "", "background": ""}, "bible": "", "book": "", "ccli": "", "content": {"origin_text": origin, "region_text": region}, "copyright": "", "date": "", "id": 115, "key": "", "lang": "", "lang_2": "", "lyricist": "", "lyrics_raw": "", "notes": "歡迎報告", "score": "", "sequence": "", "title": "歡迎報告", "transpose": "0", "type": "info", "version": "", "video": ""};
                slides.splice(pos+1, 0, info);
            }
            a_type = '';
            update_json();
        }

        $("#control_panel i").click(function() {
            data = $("#content").val();
            name = $(this).attr('name');
            if (data) {
                switch(name) {
                    case '-1':
                        $("#content").val('');
                        send_msg('');
                        break;
                    case '0':
                        send_msg(data);
                        break;
                }
            }
            else {
                switch(name) {
                    case '1':
                        add_slide(0);
                        break;
                    case '2':
                        add_slide(1);
                        break;
                    case '3':
                        add_background();
                        break;
                    case 'one':
                        apply('one');
                        break;
                    case 'all':
                        apply('all');
                        break;
                    case 'cancel':
                        cancel();
                        break;
                }
            }
        });

        $(document).on('click', '#preview_div div', function(){
            id = $(this).attr('id').split('_')[1];
            id = Number(id)
            move(1, id-order);
        });

</script>